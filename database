design the database for this project. Databse details are given below 

# Complete Database Design 

Based on your clarified requirements, here's the comprehensive database design:

## Core Relationships Summary

1. **Organization** → has many **Users** (with roles)
2. **Organization** → has many **Agents** (parent agents)
3. **Agent** → has many **Sub-agents** (hierarchical agent structure)
4. **Organization** → has many **Projects**
5. **Project** → has one or many **Agents** (assigned to project)
6. **Project** → has one or many **Users** (single chat = 1 user, group chat = multiple users)
7. **Project** → has many **Conversations** (chat sessions within project)
8. **Documents** → can be assigned to Organization, Project, or Agent level

---

## Complete Database Schema

### **1. organizations**
The top-level tenant entity.

```sql
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Basic info
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    logo_url TEXT,
    website VARCHAR(255),
    
    -- Subscription & billing
    plan_type VARCHAR(50) DEFAULT 'trial', -- trial, starter, professional, enterprise
    subscription_status VARCHAR(50) DEFAULT 'active', -- active, suspended, cancelled, expired
    subscription_started_at TIMESTAMPTZ,
    subscription_ends_at TIMESTAMPTZ,
    billing_email VARCHAR(255),
    
    -- Usage limits
    max_users INTEGER DEFAULT 10,
    max_projects INTEGER DEFAULT 5,
    max_agents INTEGER DEFAULT 10,
    max_documents INTEGER DEFAULT 1000,
    max_storage_gb INTEGER DEFAULT 10,
    max_monthly_tokens BIGINT DEFAULT 1000000,
    
    -- Settings
    settings JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "branding": {"primary_color": "#...", "logo": "..."},
    --   "security": {
    --     "require_mfa": false,
    --     "session_timeout_minutes": 60,
    --     "allowed_domains": ["company.com"]
    --   },
    --   "features": {
    --     "knowledge_graph_enabled": false,
    --     "multi_agent_collaboration": true,
    --     "advanced_analytics": false
    --   },
    --   "integrations": {"google_workspace_domain": "example.com"}
    -- }
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_organizations_slug ON organizations(slug);
CREATE INDEX idx_organizations_subscription ON organizations(subscription_status);
CREATE INDEX idx_organizations_deleted_at ON organizations(deleted_at) WHERE deleted_at IS NULL;
```

---

### **2. roles**
Predefined roles with permissions.

```sql
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    name VARCHAR(100) UNIQUE NOT NULL, -- super_admin, org_admin, project_manager, developer, analyst, viewer
    display_name VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- Permissions (can be hierarchical)
    permissions JSONB NOT NULL DEFAULT '[]'::jsonb,
    -- [
    --   "org:manage",
    --   "users:invite", "users:manage",
    --   "projects:create", "projects:manage", "projects:view",
    --   "agents:create", "agents:configure", "agents:use",
    --   "documents:upload", "documents:manage", "documents:view",
    --   "conversations:view_all", "conversations:export",
    --   "billing:manage", "integrations:manage", "analytics:view"
    -- ]
    
    -- Scope
    is_system_role BOOLEAN DEFAULT FALSE, -- System roles can't be deleted
    is_default BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Insert default system roles
INSERT INTO roles (name, display_name, description, is_system_role, is_default, permissions) VALUES
('super_admin', 'Super Administrator', 'Full system access', true, false, 
 '["org:manage", "users:invite", "users:manage", "projects:create", "projects:manage", "agents:create", "agents:configure", "agents:use", "documents:upload", "documents:manage", "conversations:view_all", "conversations:export", "billing:manage", "integrations:manage", "analytics:view"]'::jsonb),
('org_admin', 'Organization Admin', 'Manage organization and users', true, false,
 '["users:invite", "users:manage", "projects:create", "projects:manage", "agents:configure", "agents:use", "documents:upload", "documents:manage", "conversations:view_all", "integrations:manage", "analytics:view"]'::jsonb),
('project_manager', 'Project Manager', 'Manage projects and team members', true, false,
 '["projects:manage", "agents:use", "documents:upload", "documents:manage", "conversations:view_all"]'::jsonb),
('developer', 'Developer', 'Create and configure agents', true, false,
 '["projects:view", "agents:create", "agents:configure", "agents:use", "documents:upload", "documents:view"]'::jsonb),
('analyst', 'Analyst', 'Use agents and analyze data', true, true,
 '["projects:view", "agents:use", "documents:upload", "documents:view", "conversations:export"]'::jsonb),
('viewer', 'Viewer', 'Read-only access', true, false,
 '["projects:view", "documents:view"]'::jsonb);
```

---

### **3. users**
User accounts within organizations.

```sql
CREATE TYPE user_status AS ENUM ('active', 'inactive', 'suspended', 'pending_verification');

CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    role_id UUID NOT NULL REFERENCES roles(id),
    
    -- Authentication
    email VARCHAR(255) NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    hashed_password VARCHAR(255) NOT NULL,
    
    -- Profile
    full_name VARCHAR(255),
    avatar_url TEXT,
    phone VARCHAR(50),
    timezone VARCHAR(50) DEFAULT 'UTC',
    language VARCHAR(10) DEFAULT 'en',
    
    -- Status
    status user_status DEFAULT 'active' NOT NULL,
    
    -- MFA
    mfa_enabled BOOLEAN DEFAULT FALSE,
    mfa_secret TEXT, -- Encrypted TOTP secret
    backup_codes TEXT[], -- Encrypted backup codes
    
    -- Session management
    last_login_at TIMESTAMPTZ,
    last_active_at TIMESTAMPTZ,
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMPTZ,
    
    -- Preferences
    preferences JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "theme": "dark",
    --   "notifications": {
    --     "email": true,
    --     "in_app": true,
    --     "agent_mentions": true
    --   },
    --   "ui": {
    --     "default_agent": "cso",
    --     "sidebar_collapsed": false
    --   }
    -- }
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE UNIQUE INDEX idx_users_email_org ON users(email, org_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_org_id ON users(org_id);
CREATE INDEX idx_users_role_id ON users(role_id);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_last_active ON users(last_active_at DESC);
```

---

### **4. agents (Parent Agents)**
Top-level agents (CSO, CRO, CFO, etc.) that can have sub-agents.

```sql
CREATE TYPE agent_type AS ENUM (
    'cso',    -- Chief Strategy Officer
    'cro',    -- Chief Revenue Officer
    'cfo',    -- Chief Financial Officer
    'coo',    -- Chief Operating Officer
    'chro',   -- Chief Human Resources Officer
    'cto',    -- Chief Technology Officer
    'cmo',    -- Chief Marketing Officer
    'clo',    -- Chief Legal Officer
    'general', -- General purpose
    'custom'  -- Custom agent type
);

CREATE TYPE agent_status AS ENUM ('active', 'inactive', 'training', 'deprecated');

CREATE TABLE agents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Agent identification
    type agent_type NOT NULL,
    name VARCHAR(255) NOT NULL,
    display_name VARCHAR(255) NOT NULL, -- "Chief Strategy Officer", "Revenue Specialist"
    description TEXT,
    avatar_url TEXT,
    
    -- Hierarchy: null = parent agent
    parent_agent_id UUID REFERENCES agents(id) ON DELETE SET NULL,
    
    -- Agent configuration
    config JSONB NOT NULL DEFAULT '{}'::jsonb,
    -- {
    --   "system_prompt": "You are a Chief Strategy Officer...",
    --   "personality": "professional, analytical, forward-thinking",
    --   "llm": {
    --     "primary": {"provider": "openai", "model": "gpt-4"},
    --     "fallback": {"provider": "claude", "model": "claude-3-sonnet"},
    --     "temperature": 0.7,
    --     "max_tokens": 2000,
    --     "top_p": 0.9
    --   },
    --   "tools_enabled": ["memory_search", "document_lookup", "web_search", "calculator"],
    --   "memory": {
    --     "scope": "agent_and_global", -- agent_only, global_only, agent_and_global, project_only
    --     "context_window": 8000,
    --     "summary_threshold": 20
    --   },
    --   "rag": {
    --     "enabled": true,
    --     "top_k": 5,
    --     "similarity_threshold": 0.7,
    --     "rerank": true,
    --     "include_metadata": true
    --   },
    --   "capabilities": {
    --     "can_delegate_to_subagents": true,
    --     "can_request_human_approval": true,
    --     "can_access_integrations": ["google_drive", "slack"]
    --   },
    --   "guardrails": {
    --     "max_context_tokens": 8000,
    --     "enable_content_filter": true,
    --     "sensitive_data_masking": true
    --   }
    -- }
    
    -- Status
    status agent_status DEFAULT 'active' NOT NULL,
    is_visible BOOLEAN DEFAULT TRUE,
    
    -- Collaboration
    can_collaborate BOOLEAN DEFAULT TRUE, -- Can work with other agents
    can_delegate BOOLEAN DEFAULT TRUE, -- Can delegate to sub-agents
    
    -- Specialization (for sub-agents)
    specialization VARCHAR(255), -- e.g., "Market Analysis", "Financial Forecasting"
    expertise_areas TEXT[] DEFAULT ARRAY[]::TEXT[], -- ["rail", "logistics", "supply_chain"]
    
    -- Performance tracking
    total_conversations INTEGER DEFAULT 0,
    total_messages INTEGER DEFAULT 0,
    avg_response_time_ms INTEGER,
    avg_satisfaction_rating DECIMAL(3, 2), -- 0.00 to 5.00
    
    -- Version control
    version INTEGER DEFAULT 1,
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE UNIQUE INDEX idx_agents_org_type_name ON agents(org_id, type, name) WHERE deleted_at IS NULL AND parent_agent_id IS NULL;
CREATE INDEX idx_agents_org_id ON agents(org_id);
CREATE INDEX idx_agents_parent ON agents(parent_agent_id) WHERE parent_agent_id IS NOT NULL;
CREATE INDEX idx_agents_status ON agents(status);
CREATE INDEX idx_agents_type ON agents(type);
CREATE INDEX idx_agents_expertise ON agents USING GIN(expertise_areas);

COMMENT ON COLUMN agents.parent_agent_id IS 'NULL for parent agents, set for sub-agents';
```

---

### **5. projects**
Projects organize work and assign agents/users. Supports single chat (1 user) or group chat (multiple users).

```sql
CREATE TYPE project_type AS ENUM ('single_chat', 'group_chat', 'workflow', 'analysis');
CREATE TYPE project_status AS ENUM ('active', 'archived', 'paused', 'completed');

CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Project details
    name VARCHAR(255) NOT NULL,
    description TEXT,
    type project_type DEFAULT 'single_chat' NOT NULL,
    status project_status DEFAULT 'active' NOT NULL,
    
    -- Project owner/creator
    created_by UUID NOT NULL REFERENCES users(id),
    
    -- Project settings
    settings JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "chat_mode": "threaded", -- linear, threaded
    --   "agent_visibility": "all", -- all, assigned_only
    --   "document_sharing": "project", -- project, private
    --   "collaboration": {
    --     "allow_user_mentions": true,
    --     "allow_agent_mentions": true,
    --     "real_time_presence": true
    --   },
    --   "retention": {
    --     "archive_after_days": 90,
    --     "delete_after_days": 365
    --   }
    -- }
    
    -- Project scope
    objective TEXT, -- "Analyze Q4 revenue strategy"
    deliverables TEXT[], -- ["Strategic plan", "Market analysis", "Financial projections"]
    
    -- Timeline
    start_date DATE,
    target_end_date DATE,
    actual_end_date DATE,
    
    -- Activity tracking
    last_activity_at TIMESTAMPTZ,
    message_count INTEGER DEFAULT 0,
    
    -- Tags & categorization
    tags TEXT[] DEFAULT ARRAY[]::TEXT[],
    category VARCHAR(100), -- strategy, finance, operations, research
    priority VARCHAR(50) DEFAULT 'medium', -- low, medium, high, critical
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_projects_org_id ON projects(org_id);
CREATE INDEX idx_projects_created_by ON projects(created_by);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_type ON projects(type);
CREATE INDEX idx_projects_last_activity ON projects(last_activity_at DESC);
CREATE INDEX idx_projects_tags ON projects USING GIN(tags);
```

---

### **6. project_agents (Many-to-Many)**
Links agents to projects. A project can have multiple agents.

```sql
CREATE TYPE agent_role_in_project AS ENUM ('primary', 'supporting', 'advisor', 'observer');

CREATE TABLE project_agents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    agent_id UUID NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
    
    -- Role of agent in this project
    role agent_role_in_project DEFAULT 'primary' NOT NULL,
    
    -- Permissions for this agent in project
    can_initiate_conversation BOOLEAN DEFAULT TRUE,
    can_view_all_conversations BOOLEAN DEFAULT TRUE,
    can_access_project_documents BOOLEAN DEFAULT TRUE,
    
    -- Agent-specific project config override
    project_config JSONB DEFAULT '{}'::jsonb,
    -- Can override agent's default config for this specific project
    -- {
    --   "system_prompt_override": "For this project, focus on...",
    --   "tools_override": ["document_lookup", "calculator"],
    --   "priority_documents": ["doc_id_1", "doc_id_2"]
    -- }
    
    -- Activity tracking
    messages_sent INTEGER DEFAULT 0,
    last_active_at TIMESTAMPTZ,
    
    -- Assignment details
    assigned_by UUID REFERENCES users(id),
    assigned_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE UNIQUE INDEX idx_project_agents_unique ON project_agents(project_id, agent_id);
CREATE INDEX idx_project_agents_project ON project_agents(project_id);
CREATE INDEX idx_project_agents_agent ON project_agents(agent_id);
CREATE INDEX idx_project_agents_role ON project_agents(role);
```

---

### **7. project_members (Many-to-Many)**
Links users to projects. Single chat = 1 member, Group chat = multiple members.

```sql
CREATE TYPE member_role_in_project AS ENUM ('owner', 'admin', 'member', 'guest', 'observer');

CREATE TABLE project_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Role in project
    role member_role_in_project DEFAULT 'member' NOT NULL,
    
    -- Permissions
    can_invite_members BOOLEAN DEFAULT FALSE,
    can_manage_agents BOOLEAN DEFAULT FALSE,
    can_upload_documents BOOLEAN DEFAULT TRUE,
    can_export_conversations BOOLEAN DEFAULT TRUE,
    
    -- Activity tracking
    messages_sent INTEGER DEFAULT 0,
    last_viewed_at TIMESTAMPTZ,
    last_active_at TIMESTAMPTZ,
    
    -- Notifications
    notification_preferences JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "new_messages": true,
    --   "agent_responses": true,
    --   "mentions": true,
    --   "document_uploads": false
    -- }
    
    -- Invitation details
    invited_by UUID REFERENCES users(id),
    joined_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    removed_at TIMESTAMPTZ
);

CREATE UNIQUE INDEX idx_project_members_unique ON project_members(project_id, user_id) WHERE removed_at IS NULL;
CREATE INDEX idx_project_members_project ON project_members(project_id);
CREATE INDEX idx_project_members_user ON project_members(user_id);
CREATE INDEX idx_project_members_role ON project_members(role);

-- Constraint: single_chat projects can only have 1 member
CREATE OR REPLACE FUNCTION check_single_chat_member_limit()
RETURNS TRIGGER AS $$
DECLARE
    project_type_val project_type;
    member_count INTEGER;
BEGIN
    SELECT type INTO project_type_val FROM projects WHERE id = NEW.project_id;
    
    IF project_type_val = 'single_chat' THEN
        SELECT COUNT(*) INTO member_count 
        FROM project_members 
        WHERE project_id = NEW.project_id AND removed_at IS NULL;
        
        IF member_count >= 1 THEN
            RAISE EXCEPTION 'Single chat projects can only have one member';
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enforce_single_chat_limit
BEFORE INSERT ON project_members
FOR EACH ROW EXECUTE FUNCTION check_single_chat_member_limit();
```

---

### **8. conversations**
Chat sessions within a project. Each project can have multiple conversation threads.

```sql
CREATE TYPE conversation_type AS ENUM ('linear', 'threaded', 'workflow');
CREATE TYPE conversation_status AS ENUM ('active', 'archived', 'completed', 'abandoned');

CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Conversation details
    title VARCHAR(500), -- Auto-generated or user-provided
    description TEXT,
    type conversation_type DEFAULT 'linear' NOT NULL,
    status conversation_status DEFAULT 'active' NOT NULL,
    
    -- Thread hierarchy (for threaded conversations)
    parent_conversation_id UUID REFERENCES conversations(id),
    thread_depth INTEGER DEFAULT 0,
    
    -- Initiator (which user or agent started this)
    started_by_user_id UUID REFERENCES users(id),
    started_by_agent_id UUID REFERENCES agents(id),
    
    -- Primary agent for this conversation
    primary_agent_id UUID REFERENCES agents(id),
    
    -- Participating agents (can include sub-agents)
    participating_agent_ids UUID[] DEFAULT ARRAY[]::UUID[],
    
    -- Tracking
    message_count INTEGER DEFAULT 0,
    total_tokens_used BIGINT DEFAULT 0,
    total_cost_usd DECIMAL(10, 4) DEFAULT 0,
    
    -- Summary for context loading
    summary TEXT,
    summary_generated_at TIMESTAMPTZ,
    key_points TEXT[] DEFAULT ARRAY[]::TEXT[],
    
    -- Tagging
    tags TEXT[] DEFAULT ARRAY[]::TEXT[],
    
    -- Priority/Status
    is_pinned BOOLEAN DEFAULT FALSE,
    priority VARCHAR(50) DEFAULT 'normal', -- low, normal, high, urgent
    
    -- Activity
    last_message_at TIMESTAMPTZ,
    last_message_by_user_id UUID REFERENCES users(id),
    last_message_by_agent_id UUID REFERENCES agents(id),
    
    -- Resolution (for task-based conversations)
    is_resolved BOOLEAN DEFAULT FALSE,
    resolved_at TIMESTAMPTZ,
    resolved_by UUID REFERENCES users(id),
    resolution_notes TEXT,
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_conversations_project ON conversations(project_id);
CREATE INDEX idx_conversations_org ON conversations(org_id);
CREATE INDEX idx_conversations_primary_agent ON conversations(primary_agent_id);
CREATE INDEX idx_conversations_status ON conversations(status);
CREATE INDEX idx_conversations_last_message ON conversations(last_message_at DESC);
CREATE INDEX idx_conversations_parent ON conversations(parent_conversation_id) WHERE parent_conversation_id IS NOT NULL;
CREATE INDEX idx_conversations_tags ON conversations USING GIN(tags);
CREATE INDEX idx_conversations_participating_agents ON conversations USING GIN(participating_agent_ids);
```

---

### **9. messages**
Individual messages in conversations.

```sql
CREATE TYPE message_role AS ENUM ('user', 'assistant', 'system', 'tool', 'human_feedback');
CREATE TYPE message_status AS ENUM ('sending', 'sent', 'delivered', 'read', 'error', 'deleted');

CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Sender
    role message_role NOT NULL,
    user_id UUID REFERENCES users(id), -- If from user
    agent_id UUID REFERENCES agents(id), -- If from agent
    
    -- Message content
    content TEXT NOT NULL,
    content_type VARCHAR(50) DEFAULT 'text', -- text, markdown, html, json, code
    
    -- Rich content
    attachments JSONB DEFAULT '[]'::jsonb,
    -- [
    --   {"type": "image", "url": "...", "size": 12345, "mime_type": "image/png"},
    --   {"type": "file", "url": "...", "filename": "report.pdf"}
    -- ]
    
    -- Message threading (for replies)
    reply_to_message_id UUID REFERENCES messages(id),
    
    -- Status
    status message_status DEFAULT 'sent' NOT NULL,
    error_message TEXT,
    error_code VARCHAR(100),
    
    -- Token tracking
    prompt_tokens INTEGER,
    completion_tokens INTEGER,
    total_tokens INTEGER,
    cost_usd DECIMAL(10, 6),
    
    -- LLM execution details
    llm_provider VARCHAR(50),
    llm_model VARCHAR(100),
    llm_temperature DECIMAL(3, 2),
    response_time_ms INTEGER,
    time_to_first_token_ms INTEGER,
    
    -- Context & explainability
    context_used JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "documents": [
    --     {"id": "...", "title": "...", "relevance_score": 0.85, "chunks_used": 3}
    --   ],
    --   "previous_messages_count": 5,
    --   "summary_used": true,
    --   "tools_called": [
    --     {"name": "memory_search", "duration_ms": 150, "results_count": 5},
    --     {"name": "calculator", "expression": "100 * 1.15", "result": 115}
    --   ],
    --   "sub_agents_consulted": [
    --     {"agent_id": "...", "agent_name": "Market Analyst", "input": "...", "output": "..."}
    --   ],
    --   "memory_retrieved": {"chunks": 3, "total_tokens": 1500}
    -- }
    
    -- User feedback
    user_rating INTEGER CHECK (user_rating BETWEEN 1 AND 5),
    user_feedback TEXT,
    feedback_at TIMESTAMPTZ,
    is_helpful BOOLEAN,
    
    -- Mentions (for group chats)
    mentions_user_ids UUID[] DEFAULT ARRAY[]::UUID[],
    mentions_agent_ids UUID[] DEFAULT ARRAY[]::UUID[],
    
    -- Read receipts
    read_by_user_ids UUID[] DEFAULT ARRAY[]::UUID[],
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    -- Editing support
    edited_at TIMESTAMPTZ,
    edit_history JSONB DEFAULT '[]'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at);
CREATE INDEX idx_messages_project ON messages(project_id);
CREATE INDEX idx_messages_user ON messages(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_messages_agent ON messages(agent_id) WHERE agent_id IS NOT NULL;
CREATE INDEX idx_messages_role ON messages(role);
CREATE INDEX idx_messages_reply_to ON messages(reply_to_message_id) WHERE reply_to_message_id IS NOT NULL;
CREATE INDEX idx_messages_mentions_users ON messages USING GIN(mentions_user_ids);
CREATE INDEX idx_messages_mentions_agents ON messages USING GIN(mentions_agent_ids);
CREATE INDEX idx_messages_context ON messages USING GIN(context_used);
```

---

### **10. documents**
Documents can be assigned at org, project, or agent level.

```sql
CREATE TYPE document_type AS ENUM (
    'pdf', 'docx', 'pptx', 'xlsx', 'csv',
    'txt', 'md', 'json', 'xml',
    'image', 'video', 'audio',
    'url', 'email', 'slack_thread', 'code'
);

CREATE TYPE document_status AS ENUM (
    'uploading', 'uploaded', 'processing', 
    'ingested', 'failed', 'archived'
);

CREATE TYPE document_scope AS ENUM (
    'organization',  -- Available to entire org
    'project',       -- Available only to specific project
    'agent',         -- Available only to specific agent(s)
    'private'        -- Private to uploader
);

CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Scope assignment (NULL = organization-wide)
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    
    -- Ownership
    uploaded_by UUID NOT NULL REFERENCES users(id),
    
    -- File details
    filename VARCHAR(500) NOT NULL,
    original_filename VARCHAR(500) NOT NULL,
    file_type document_type NOT NULL,
    mime_type VARCHAR(255),
    file_size_bytes BIGINT NOT NULL,
    checksum VARCHAR(64), -- SHA-256 for deduplication
    
    -- Storage
    storage_path TEXT NOT NULL,
    storage_backend VARCHAR(50) DEFAULT 's3', -- s3, gcs, azure, local
    storage_url TEXT, -- Presigned URL or CDN URL
    
    -- Processing status
    status document_status DEFAULT 'uploaded' NOT NULL,
    ingestion_started_at TIMESTAMPTZ,
    ingestion_completed_at TIMESTAMPTZ,
    ingestion_error TEXT,
    retry_count INTEGER DEFAULT 0,
    
    -- Content extraction
    extracted_text TEXT,
    text_length INTEGER,
    language VARCHAR(10),
    page_count INTEGER,
    
    -- Embedding info
    embedding_model VARCHAR(100),
    chunks_count INTEGER DEFAULT 0,
    embeddings_generated_at TIMESTAMPTZ,
    
    -- Metadata
    title VARCHAR(500),
    description TEXT,
    author VARCHAR(255),
    source_url TEXT,
    source_integration VARCHAR(50), -- google_drive, slack, manual
    external_id VARCHAR(255), -- ID in source system
    
    -- Classification
    tags TEXT[] DEFAULT ARRAY[]::TEXT[],
    category VARCHAR(100),
    keywords TEXT[] DEFAULT ARRAY[]::TEXT[],
    
    -- Access control
    scope document_scope DEFAULT 'organization' NOT NULL,
    assigned_agent_ids UUID[] DEFAULT ARRAY[]::UUID[], -- Specific agents that can access
    shared_with_project_ids UUID[] DEFAULT ARRAY[]::UUID[], -- Additional projects with access
    
    -- Version control
    version INTEGER DEFAULT 1,
    parent_document_id UUID REFERENCES documents(id),
    is_latest_version BOOLEAN DEFAULT TRUE,
    
    -- Usage tracking
    view_count INTEGER DEFAULT 0,
    download_count INTEGER DEFAULT 0,
    citation_count INTEGER DEFAULT 0,
    last_accessed_at TIMESTAMPTZ,
    
    -- Expiration (for temporary documents)
    expires_at TIMESTAMPTZ,
    
    -- Rich metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "custom_fields": {"department": "Sales", "quarter": "Q3-2024"},
    --   "extraction": {
    --     "entities": ["RailVision", "Class I Rail"],
    --     "keywords": ["strategy", "expansion"],
    --     "summary": "..."
    --   },
    --   "integration": {
    --     "source": "google_drive",
    --     "drive_id": "...",
    --     "last_modified": "..."
    --   }
    -- }
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_documents_org ON documents(org_
id);
CREATE INDEX idx_documents_project ON documents(project_id) WHERE project_id IS NOT NULL;
CREATE INDEX idx_documents_uploaded_by ON documents(uploaded_by);
CREATE INDEX idx_documents_status ON documents(status);
CREATE INDEX idx_documents_scope ON documents(scope);
CREATE INDEX idx_documents_tags ON documents USING GIN(tags);
CREATE INDEX idx_documents_assigned_agents ON documents USING GIN(assigned_agent_ids);
CREATE INDEX idx_documents_shared_projects ON documents USING GIN(shared_with_project_ids);
CREATE INDEX idx_documents_checksum ON documents(checksum);
CREATE INDEX idx_documents_external ON documents(source_integration, external_id);

-- Full-text search
CREATE INDEX idx_documents_text_search ON documents USING GIN(to_tsvector('english', COALESCE(title, '') || ' ' || COALESCE(description, '') || ' ' || COALESCE(extracted_text, '')));
```

---

### **11. document_chunks**
Chunked text with embeddings (reference to Pinecone).

```sql
CREATE TABLE document_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id), -- Inherited from document
    
    -- Chunk details
    chunk_index INTEGER NOT NULL,
    chunk_text TEXT NOT NULL,
    chunk_tokens INTEGER NOT NULL,
    
    -- Embedding reference
    pinecone_id VARCHAR(255) UNIQUE,
    embedding_model VARCHAR(100),
    embedding_dimension INTEGER DEFAULT 1536,
    
    -- Context preservation
    preceding_text TEXT,
    following_text TEXT,
    
    -- Document context
    page_number INTEGER,
    section_title VARCHAR(500),
    paragraph_index INTEGER,
    
    -- Metadata for filtering
    chunk_metadata JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "section": "Market Analysis",
    --   "subsection": "Competitive Landscape",
    --   "importance_score": 0.85
    -- }
    
    -- Usage tracking
    access_count INTEGER DEFAULT 0,
    citation_count INTEGER DEFAULT 0,
    last_accessed_at TIMESTAMPTZ,
    avg_relevance_score DECIMAL(5, 4), -- Average score when retrieved
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_chunks_document ON document_chunks(document_id, chunk_index);
CREATE INDEX idx_chunks_org ON document_chunks(org_id);
CREATE INDEX idx_chunks_project ON document_chunks(project_id) WHERE project_id IS NOT NULL;
CREATE INDEX idx_chunks_pinecone ON document_chunks(pinecone_id);
```

---

### **12. integrations**
External service connections.

```sql
CREATE TYPE integration_type AS ENUM (
    'google_drive', 'google_workspace',
    'microsoft_onedrive', 'microsoft_teams',
    'slack', 'discord',
    'dropbox', 'box',
    'salesforce', 'hubspot',
    'notion', 'confluence', 'jira',
    'github', 'gitlab',
    'custom_api'
);

CREATE TYPE integration_status AS ENUM (
    'connected', 'disconnected', 'error',
    'auth_expired', 'rate_limited'
);

CREATE TABLE integrations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Integration details
    type integration_type NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    status integration_status DEFAULT 'connected' NOT NULL,
    
    -- OAuth/API credentials (encrypted at application layer)
    access_token TEXT,
    refresh_token TEXT,
    token_expires_at TIMESTAMPTZ,
    api_key TEXT,
    
    -- Integration config
    config JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "google_drive": {
    --     "folders": ["folder_id_1", "folder_id_2"],
    --     "file_types": ["pdf", "docx"],
    --     "auto_sync": true,
    --     "sync_frequency": "hourly"
    --   },
    --   "slack": {
    --     "channels": ["#general", "#strategy"],
    --     "keywords_to_track": ["urgent", "deadline"],
    --     "bot_user_id": "..."
    --   }
    -- }
    
    -- Sync settings
    auto_sync_enabled BOOLEAN DEFAULT FALSE,
    sync_frequency VARCHAR(50) DEFAULT 'daily', -- hourly, daily, weekly, manual
    last_sync_at TIMESTAMPTZ,
    last_sync_status VARCHAR(50),
    last_sync_error TEXT,
    next_sync_at TIMESTAMPTZ,
    
    -- Statistics
    total_files_synced INTEGER DEFAULT 0,
    total_sync_runs INTEGER DEFAULT 0,
    failed_sync_count INTEGER DEFAULT 0,
    
    -- Scope (can be org-wide or project-specific)
    is_org_wide BOOLEAN DEFAULT TRUE,
    project_ids UUID[] DEFAULT ARRAY[]::UUID[], -- If project-specific
    
    -- Connection details
    connected_by UUID NOT NULL REFERENCES users(id),
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_integrations_org ON integrations(org_id);
CREATE INDEX idx_integrations_type ON integrations(type);
CREATE INDEX idx_integrations_status ON integrations(status);
CREATE INDEX idx_integrations_next_sync ON integrations(next_sync_at) WHERE auto_sync_enabled = TRUE;
CREATE INDEX idx_integrations_projects ON integrations USING GIN(project_ids);
```

---

### **13. llm_usage_logs**
Track all LLM API calls.

```sql
CREATE TABLE llm_usage_logs (
    id BIGSERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id),
    user_id UUID REFERENCES users(id),
    agent_id UUID REFERENCES agents(id),
    
    -- Context
    conversation_id UUID REFERENCES conversations(id),
    message_id UUID REFERENCES messages(id),
    
    -- LLM details
    provider VARCHAR(50) NOT NULL,
    model VARCHAR(100) NOT NULL,
    endpoint VARCHAR(100),
    
    -- Usage
    prompt_tokens INTEGER NOT NULL,
    completion_tokens INTEGER,
    total_tokens INTEGER NOT NULL,
    
    -- Cost
    cost_usd DECIMAL(10, 6),
    
    -- Performance
    request_duration_ms INTEGER,
    time_to_first_token_ms INTEGER,
    tokens_per_second DECIMAL(10, 2),
    
    -- Status
    status VARCHAR(50) NOT NULL,
    error_code VARCHAR(100),
    error_message TEXT,
    
    -- Rate limiting
    rate_limit_remaining INTEGER,
    rate_limit_reset_at TIMESTAMPTZ,
    
    -- Request fingerprint
    request_hash VARCHAR(64),
    
    -- Metadata
    metadata JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_llm_logs_org_created ON llm_usage_logs(org_id, created_at DESC);
CREATE INDEX idx_llm_logs_project ON llm_usage_logs(project_id) WHERE project_id IS NOT NULL;
CREATE INDEX idx_llm_logs_user ON llm_usage_logs(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_llm_logs_agent ON llm_usage_logs(agent_id) WHERE agent_id IS NOT NULL;
CREATE INDEX idx_llm_logs_conversation ON llm_usage_logs(conversation_id) WHERE conversation_id IS NOT NULL;
CREATE INDEX idx_llm_logs_provider_model ON llm_usage_logs(provider, model);

-- Partition by month for performance
```

---

### **14. audit_logs**
Comprehensive audit trail.

```sql
CREATE TYPE audit_action AS ENUM (
    -- Auth
    'user_login', 'user_logout', 'user_login_failed', 'password_changed',
    
    -- Users
    'user_created', 'user_updated', 'user_deleted', 'user_invited', 'role_changed',
    
    -- Organizations
    'org_created', 'org_updated', 'org_settings_changed', 'subscription_changed',
    
    -- Projects
    'project_created', 'project_updated', 'project_deleted', 'project_archived',
    'project_member_added', 'project_member_removed', 'project_agent_assigned',
    
    -- Agents
    'agent_created', 'agent_updated', 'agent_deleted', 'agent_config_changed',
    'agent_executed', 'sub_agent_created',
    
    -- Documents
    'document_uploaded', 'document_viewed', 'document_downloaded',
    'document_deleted', 'document_shared', 'document_ingested',
    
    -- Conversations
    'conversation_started', 'message_sent', 'conversation_archived',
    
    -- Integrations
    'integration_connected', 'integration_disconnected', 'integration_synced'
);

CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id),
    
    -- Actor
    user_id UUID REFERENCES users(id),
    
    -- Action
    action audit_action NOT NULL,
    resource_type VARCHAR(100),
    resource_id UUID,
    
    -- Details
    details JSONB DEFAULT '{}'::jsonb,
    -- {
    --   "changes": {"field": "status", "old": "active", "new": "archived"},
    --   "ip_address": "192.168.1.1",
    --   "user_agent": "...",
    --   "additional_context": {...}
    -- }
    
    -- Request context
    ip_address INET,
    user_agent TEXT,
    request_id UUID,
    
    -- Result
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_audit_org_created ON audit_logs(org_id, created_at DESC);
CREATE INDEX idx_audit_project ON audit_logs(project_id) WHERE project_id IS NOT NULL;
CREATE INDEX idx_audit_user ON audit_logs(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_audit_action ON audit_logs(action);
CREATE INDEX idx_audit_resource ON audit_logs(resource_type, resource_id);
```

---

### **15. notifications**
In-app and email notifications.

```sql
CREATE TYPE notification_type AS ENUM (
    'mention', 'reply', 'agent_response', 'project_invite',
    'document_shared', 'task_assigned', 'project_update',
    'system_alert'
);

CREATE TYPE notification_status AS ENUM ('unread', 'read', 'archived');

CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Notification details
    type notification_type NOT NULL,
    title VARCHAR(500) NOT NULL,
    message TEXT NOT NULL,
    status notification_status DEFAULT 'unread' NOT NULL,
    
    -- Links
    project_id UUID REFERENCES projects(id),
    conversation_id UUID REFERENCES conversations(id),
    message_id UUID REFERENCES messages(id),
    document_id UUID REFERENCES documents(id),
    
    -- Action
    action_url TEXT,
    action_label VARCHAR(100),
    
    -- Sender (optional)
    from_user_id UUID REFERENCES users(id),
    from_agent_id UUID REFERENCES agents(id),
    
    -- Delivery
    read_at TIMESTAMPTZ,
    email_sent BOOLEAN DEFAULT FALSE,
    email_sent_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_notifications_user_status ON notifications(user_id, status, created_at DESC);
CREATE INDEX idx_notifications_org ON notifications(org_id);
CREATE INDEX idx_notifications_type ON notifications(type);
```

---

## Supporting Tables

### **16. user_invitations**

```sql
CREATE TYPE invitation_status AS ENUM ('pending', 'accepted', 'expired', 'cancelled');

CREATE TABLE user_invitations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    email VARCHAR(255) NOT NULL,
    role_id UUID NOT NULL REFERENCES roles(id),
    invited_by UUID NOT NULL REFERENCES users(id),
    
    -- Projects to add user to upon acceptance
    project_ids UUID[] DEFAULT ARRAY[]::UUID[],
    
    -- Token
    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    
    -- Status
    status invitation_status DEFAULT 'pending' NOT NULL,
    accepted_at TIMESTAMPTZ,
    accepted_by UUID REFERENCES users(id),
    
    -- Message
    invitation_message TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_invitations_token ON user_invitations(token);
CREATE INDEX idx_invitations_org_status ON user_invitations(org_id, status);
CREATE INDEX idx_invitations_email ON user_invitations(email);
```

---

### **17. refresh_tokens**

```sql
CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    
    -- Device tracking
    device_name VARCHAR(255),
    ip_address INET,
    user_agent TEXT,
    
    -- Lifecycle
    expires_at TIMESTAMPTZ NOT NULL,
    revoked_at TIMESTAMPTZ,
    revoked_reason VARCHAR(100),
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_refresh_tokens_user ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_token_hash ON refresh_tokens(token_hash);
```

---

### **18. agent_collaboration_logs**
Track when agents work together or delegate to sub-agents.

```sql
CREATE TYPE collaboration_type AS ENUM ('delegation', 'consultation', 'parallel_execution', 'sequential_workflow');

CREATE TABLE agent_collaboration_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id),
    conversation_id UUID REFERENCES conversations(id),
    message_id UUID REFERENCES messages(id),
    
    -- Collaboration details
    type collaboration_type NOT NULL,
    primary_agent_id UUID NOT NULL REFERENCES agents(id),
    collaborating_agent_id UUID NOT NULL REFERENCES agents(id),
    
    -- Context
    task_description TEXT,
    input_data JSONB,
    output_data JSONB,
    
    -- Performance
    duration_ms INTEGER,
    tokens_used INTEGER,
    cost_usd DECIMAL(10, 6),
    
    -- Result
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_collab_primary_agent ON agent_collaboration_logs(primary_agent_id);
CREATE INDEX idx_collab_collaborating_agent ON agent_collaboration_logs(collaborating_agent_id);
CREATE INDEX idx_collab_conversation ON agent_collaboration_logs(conversation_id);
```

---

## Database Functions & Triggers

### **Update updated_at timestamps**

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all tables with updated_at
CREATE TRIGGER tr_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER tr_organizations_updated_at BEFORE UPDATE ON organizations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER tr_agents_updated_at BEFORE UPDATE ON agents
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER tr_projects_updated_at BEFORE UPDATE ON projects
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER tr_conversations_updated_at BEFORE UPDATE ON conversations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER tr_documents_updated_at BEFORE UPDATE ON documents
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Continue for other tables...
```

---

### **Update conversation stats on message insert**

```sql
CREATE OR REPLACE FUNCTION update_conversation_on_message()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE conversations
    SET 
        message_count = message_count + 1,
        last_message_at = NEW.created_at,
        last_message_by_user_id = NEW.user_id,
        last_message_by_agent_id = NEW.agent_id,
        total_tokens_used = total_tokens_used + COALESCE(NEW.total_tokens, 0),
        total_cost_usd = total_cost_usd + COALESCE(NEW.cost_usd, 0)
    WHERE id = NEW.conversation_id;
    
    -- Also update project last activity
    UPDATE projects
    SET 
        last_activity_at = NEW.created_at,
        message_count = message_count + 1
    WHERE id = NEW.project_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_message_insert_update_conversation
AFTER INSERT ON messages
FOR EACH ROW EXECUTE FUNCTION update_conversation_on_message();
```

---

### **Track document citations**

```sql
CREATE OR REPLACE FUNCTION track_document_citation()
RETURNS TRIGGER AS $$
DECLARE
    doc_id UUID;
BEGIN
    IF NEW.context_used IS NOT NULL AND NEW.context_used ? 'documents' THEN
        FOR doc_id IN 
            SELECT (doc->>'id')::UUID
            FROM jsonb_array_elements(NEW.context_used->'documents') AS doc
        LOOP
            UPDATE documents
            SET 
                citation_count = citation_count + 1,
                last_accessed_at = NOW()
            WHERE id = doc_id;
        END LOOP;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_track_citations
AFTER INSERT ON messages
FOR EACH ROW EXECUTE FUNCTION track_document_citation();
```

---

### **Prevent deleting last org admin**

```sql
CREATE OR REPLACE FUNCTION prevent_last_admin_deletion()
RETURNS TRIGGER AS $$
DECLARE
    admin_count INTEGER;
    admin_role_id UUID;
BEGIN
    -- Get admin role ID
    SELECT id INTO admin_role_id FROM roles WHERE name = 'org_admin';
    
    IF OLD.role_id = admin_role_id THEN
        SELECT COUNT(*) INTO admin_count
        FROM users
        WHERE org_id = OLD.org_id 
        AND role_id = admin_role_id
        AND deleted_at IS NULL
        AND id != OLD.id;
        
        IF admin_count = 0 THEN
            RAISE EXCEPTION 'Cannot delete or deactivate the last admin of an organization';
        END IF;
    END IF;
    
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_prevent_last_admin_deletion
BEFORE DELETE OR UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION prevent_last_admin_deletion();
```

---

## Sample Queries

### **Get project with all agents and members**

```sql
SELECT 
    p.*,
    json_agg(DISTINCT jsonb_build_object(
        'agent_id', a.id,
        'agent_name', a.name,
        'agent_type', a.type,
        'role', pa.role
    )) as agents,
    json_agg(DISTINCT jsonb_build_object(
        'user_id', u.id,
        'user_name', u.full_name,
        'user_email', u.email,
        'role', pm.role
    )) as members
FROM projects p
LEFT JOIN project_agents pa ON pa.project_id = p.id
LEFT JOIN agents a ON a.id = pa.agent_id
LEFT JOIN project_members pm ON pm.project_id = p.id AND pm.removed_at IS NULL
LEFT JOIN users u ON u.id = pm.user_id
WHERE p.id = $1
GROUP BY p.id;
```

---

### **Get agent hierarchy (parent + sub-agents)**

```sql
WITH RECURSIVE agent_hierarchy AS (
    -- Parent agents
    SELECT 
        id, name, type, parent_agent_id, 
        0 as depth,
        ARRAY[id] as path
    FROM agents
    WHERE parent_agent_id IS NULL
    AND org_id = $1
    
    UNION ALL
    
    -- Sub-agents
    SELECT 
        a.id, a.name, a.type, a.parent_agent_id,
        ah.depth + 1,
        ah.path || a.id
    FROM agents a
    INNER JOIN agent_hierarchy ah ON a.parent_agent_id = ah.id
)
SELECT * FROM agent_hierarchy
ORDER BY path;
```

---

### **Get user's accessible documents (considering project membership and agent assignments)**

```sql
SELECT DISTINCT d.*
FROM documents d
LEFT JOIN project_members pm ON pm.user_id = $1 AND pm.removed_at IS NULL
WHERE d.org_id = (SELECT org_id FROM users WHERE id = $1)
AND (
    -- Organization-wide documents
    d.scope = 'organization'
    OR
    -- User is member of document's project
    (d.scope = 'project' AND d.project_id = pm.project_id)
    OR
    -- Document shared with user's projects
    (d.scope = 'project' AND pm.project_id = ANY(d.shared_with_project_ids))
    OR
    -- User uploaded the document
    d.uploaded_by = $1
)
AND d.deleted_at IS NULL
ORDER BY d.created_at DESC;
```

---

This comprehensive database design supports  complete requirements including organization hierarchy, user roles, parent agents with sub-agents, projects with multiple agents/users, and flexible document access control!